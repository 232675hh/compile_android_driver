name: Android14-6.1

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4.2.2
        
      - name: Prepare kerneldriver directory
        run: |
          mkdir kerneldriver
          mv ./code/*.h ./code/*.c ./code/Makefile kerneldriver/
          
      - name: Install repo tool
        run: |
          sudo curl -L https://storage.googleapis.com/git-repo-downloads/repo -o /usr/local/bin/repo
          sudo chmod a+x /usr/local/bin/repo

      - name: Set up Android Kernel source
        run: |
          mkdir -p android-kernel && cd android-kernel
          repo init -u https://android.googlesource.com/kernel/manifest -b common-android14-6.1
          repo sync

      - name: Copy kerneldriver
        run: |
          cd android-kernel
          cp -r ../kerneldriver common/drivers

      - name: Modify Makefile
        run: |
          cd android-kernel
          echo "obj-y += kerneldriver/" >> common/drivers/Makefile

      # 新增步骤：将模块添加到 GKI 模块列表（保持排序）
      - name: Add module to GKI modules list
        run: |
          cd android-kernel
          # 插入新模块并保持列表排序
          awk -i inplace '
            BEGIN { added=0 }
            /_COMMON_GKI_MODULES_LIST = \[/ { in_list=1 }
            in_list && /\]/ {
              # 确保在列表结束前添加新模块（如果尚未添加）
              if (!added) {
                print "    \"drivers/kerneldriver/rwProcMem_module.ko\","
                added=1
              }
              in_list=0
            }
            in_list && !added && /drivers\/kerneldriver/ { next }  # 避免重复
            in_list && !added {
              # 按字母顺序插入到正确位置
              if ("drivers/kerneldriver/rwProcMem_module.ko" < $0) {
                print "    \"drivers/kerneldriver/rwProcMem_module.ko\","
                added=1
              }
            }
            { print }
          ' common/modules.bzl

      - name: Increase stack frame size limit
        run: |
          cd android-kernel
          # 查找并替换所有包含WARN的配置项
          find . -type f -name "Makefile*" -exec sed -i 's/-Wframe-larger-than=[0-9]*/-Wframe-larger-than=4096/g' {} +
          # 添加新配置（如果不存在）
          grep -q "FRAME_WARN" common/Makefile || echo 'KBUILD_CFLAGS += -Wframe-larger-than=4096' >> common/Makefile

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential flex bison libssl-dev libelf-dev bc

      - name: Build kernel module
        run: |
          cd android-kernel
          tools/bazel run //common:kernel_aarch64_dist
        continue-on-error: true
        
      - name: Upload kerneldriver.ko
        uses: actions/upload-artifact@v4.6.2
        with:
          name: kerneldriver
          path: android-kernel/out/kernel_aarch64
